---
# Disable password authentication for all users (SAML-only enforcement)
#
# This playbook enforces SAML-only authentication system-wide by setting
# all user passwords to unusable. This is a one-time migration for existing
# production deployments.
#
# Usage:
#   ansible-playbook -i inventories/production/hosts.yml playbooks/disable-passwords.yml \
#     --connection local --ask-vault-pass
#
# Options:
#   --skip-confirmation: Skip confirmation prompt
#     ansible-playbook -i inventories/production/hosts.yml playbooks/disable-passwords.yml \
#       -e 'skip_confirmation=true' --connection local --ask-vault-pass

- name: Disable password authentication for all users
  hosts: services
  become: yes
  gather_facts: yes

  vars:
    skip_confirmation: false

  tasks:
    - name: Display warning message
      debug:
        msg:
          - "=========================================="
          - "DISABLE PASSWORD AUTHENTICATION"
          - "=========================================="
          - ""
          - "This will disable password authentication for ALL users."
          - "Users will ONLY be able to authenticate via SAML."
          - ""
          - "Environment: {{ naaccord_environment }}"
          - "Server: {{ ansible_hostname }}"
          - ""

    - name: Confirm operation (unless skip_confirmation=true)
      pause:
        prompt: |

          ⚠️  WARNING: This will disable password login for ALL users!

          Type 'DISABLE' to confirm, or Ctrl+C to cancel
      register: confirmation
      when: not skip_confirmation | bool

    - name: Validate confirmation
      fail:
        msg: "Operation cancelled - confirmation text did not match 'DISABLE'"
      when:
        - not skip_confirmation | bool
        - confirmation.user_input != 'DISABLE'

    - name: Disable all passwords (services container)
      command: >
        docker exec naaccord-services
        python manage.py disable_all_passwords --skip-confirmation
      register: disable_result
      changed_when: "'Disabled passwords for' in disable_result.stdout"

    - name: Display command output
      debug:
        var: disable_result.stdout_lines

    - name: Count total users
      command: >
        docker exec naaccord-services python manage.py shell -c
        "from django.contrib.auth import get_user_model; print(get_user_model().objects.count())"
      register: total_users
      changed_when: false

    - name: Count users with usable passwords
      command: >
        docker exec naaccord-services python manage.py shell -c
        "from django.contrib.auth import get_user_model; print(get_user_model().objects.filter(password__regex=r'^[^!]').count())"
      register: usable_passwords
      changed_when: false

    - name: Display verification results
      debug:
        msg:
          - "=========================================="
          - "VERIFICATION RESULTS"
          - "=========================================="
          - "Total users: {{ total_users.stdout | trim }}"
          - "Users with usable passwords: {{ usable_passwords.stdout | trim }}"
          - "Users with unusable passwords: {{ (total_users.stdout | int) - (usable_passwords.stdout | int) }}"
          - ""
          - "✅ Password authentication disabled"
          - "✅ All users now require SAML authentication"

    - name: Fail if any usable passwords remain
      fail:
        msg: "ERROR: {{ usable_passwords.stdout | trim }} user(s) still have usable passwords!"
      when: (usable_passwords.stdout | int) > 0

  handlers: []
