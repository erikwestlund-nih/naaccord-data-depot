---
# Escalate scan support user to superuser/admin for second security scan

- name: Escalate scan user to superuser
  become: true
  become_user: naaccord
  ansible.builtin.command:
    cmd: >
      docker exec naaccord-services
      python manage.py escalate_scan_user
      --jhed {{ scan_user_jhed }}
  register: escalate_result
  changed_when: "'✓ USER ESCALATED TO SUPERUSER/ADMIN' in escalate_result.stdout"
  failed_when: escalate_result.rc != 0
  tags:
    - scan_user
    - scan_user_escalate

- name: Display escalation output
  ansible.builtin.debug:
    msg: "{{ escalate_result.stdout_lines }}"
  tags:
    - scan_user
    - scan_user_escalate

- name: Save escalation timestamp
  ansible.builtin.set_fact:
    scan_user_escalated_at: "{{ ansible_date_time.iso8601 }}"
  tags:
    - scan_user
    - scan_user_escalate

- name: Warn about elevated privileges
  ansible.builtin.debug:
    msg:
      - "⚠️  WARNING: Scan user now has FULL ADMIN ACCESS"
      - "⚠️  Remember to deescalate when second scan is complete"
      - "⚠️  Run: ansible-playbook playbooks/scan-user.yml -e 'scan_user_action=deescalate'"
  tags:
    - scan_user
    - scan_user_escalate
