<c-app-page title="File Submissions">

    <c-page_header
        heading="File Submissions"
        blurb="View and manage data submissions across all protocol years. Track submission status and access validation reports."
    />

    <div x-data="{ 
        searchTerm: '',
        isVisible(submission) {
            if (this.searchTerm === '') return true;
            const term = this.searchTerm.toLowerCase();
            return submission.cohort.toLowerCase().includes(term) || 
                   submission.protocol_year.toLowerCase().includes(term) || 
                   submission.status.toLowerCase().includes(term) || 
                   submission.started_by.toLowerCase().includes(term);
        }
    }">
    {% if submissions %}
    <div class="sm:flex sm:items-center">
        <div class="sm:flex-auto">
            {% if submissions|length > 1 %}
            <div class="w-48 mt-2 text-sm text-gray-700">
                <div class="relative rounded-md">
                    <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                        <c-icon icon="magnifying-glass" family="regular" class="h-4 w-4 text-gray-400" />
                    </div>
                    <input
                        type="text"
                        x-model="searchTerm"
                        placeholder="Search submissions"
                        class="block w-full rounded-md border-0 py-1.5 pl-10 text-gray-900 bg-white ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-red-600 focus:outline-none sm:text-sm sm:leading-6"
                    >
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% if submissions %}
    <c-card variant="table" no_border="true" class="mt-8">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-300">
                <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-6">Cohort</th>
                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Protocol Year</th>
                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Status</th>
                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Started By</th>
                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Created</th>
                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Data Tables Uploaded</th>
                    <th scope="col" class="relative py-3.5 pl-3 pr-4 sm:pr-6"><span class="sr-only">Actions</span></th>
                </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 bg-white">
                {% for submission in submissions %}
                    <tr x-show="isVisible({
                            cohort: '{{ submission.cohort }}',
                            protocol_year: '{{ submission.protocol_year }}',
                            status: '{{ submission.status }}',
                            started_by: '{{ submission.started_by }}'
                        })"
                        x-transition
                        class="hover:bg-gray-50 cursor-pointer"
                        onclick="window.location.href='{% url 'submission_detail' submission.id %}'">
                        <td class="py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-6">{{ submission.cohort }}</td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">{{ submission.protocol_year }}</td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                            {% if submission.status == "Draft" %}
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-200 text-gray-900">{{ submission.status }}</span>
                            {% elif submission.status == "In Progress" %}
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">{{ submission.status }}</span>
                            {% elif submission.status == "Completed" %}
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">{{ submission.status }}</span>
                            {% elif submission.status == "Signed Off" %}
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">{{ submission.status }}</span>
                            {% else %}
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-200 text-gray-900">{{ submission.status }}</span>
                            {% endif %}
                        </td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">{{ submission.started_by }}</td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">{{ submission.created_at|date:"Y-m-d" }}</td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                            {{ submission.tables_with_files }}
                        </td>
                        <td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-6">
                            <a href="{% url 'submission_detail' submission.id %}" class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-md bg-blue-600 text-white hover:bg-blue-700 text-sm font-medium shadow-sm">
                                <c-icon icon="folder-open" family="solid" class="h-4 w-4" />
                                Open Submission
                                <span class="sr-only">, {{ submission.cohort }}</span>
                            </a>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </c-card>
    {% endif %}

    <!-- Create New Submission Form -->
    {% if submissions %}
    <div class="my-10 border-t border-gray-300"></div>
    {% endif %}
    <div {% if submissions %}id="create-form"{% endif %}>
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Create Submission</h2>

        {% if not submissions %}
        <p class="text-sm text-gray-600 mb-6">No submissions yet. Start one below!</p>
        {% endif %}

        <div class="bg-white shadow rounded-lg p-6 max-w-2xl">
            <form method="post" class="space-y-6">
                {% csrf_token %}

                {% if form.non_field_errors %}
                    <div class="rounded-md bg-red-50 p-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-red-800">{{ form.non_field_errors|first }}</h3>
                            </div>
                        </div>
                    </div>
                {% endif %}

                <div>
                    <label for="protocol_year" class="block text-sm font-medium text-gray-700 mb-2">Protocol Year</label>
                    <c-input.select
                        name="protocol_year"
                        :options="protocol_year_options"
                        :value="form_data.protocol_year"
                        :errors="errors"
                    />
                    <p class="mt-2 text-sm text-gray-500">
                        Select the protocol year for this submission.
                    </p>
                </div>

                <div>
                    <label for="cohort" class="block text-sm font-medium text-gray-700 mb-2">Cohort</label>
                    <c-input.select
                        name="cohort"
                        :options="cohort_options"
                        :value="form_data.cohort"
                        :errors="errors"
                    />
                    <p class="mt-2 text-sm text-gray-500">
                        Select the cohort you want to create a submission for. Only active cohorts you have access to are shown.
                    </p>
                </div>

                <div class="flex items-center justify-end gap-x-6">
                    <button type="submit" class="rounded-md bg-green-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-green-600">
                        Create Submission
                    </button>
                </div>
            </form>
        </div>
    </div>
    </div>

</c-app-page>